#!/bin/bash

# Pre-commit hook for dotfiles repository
# Performs linting and validation before commits
# Uses Docker for platform-independent linting (with local fallback)

set -e

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
DOCKER_IMAGE="dotfiles-linters:latest"

# Check if Docker is available
has_docker() {
    command -v docker &>/dev/null && docker info &>/dev/null 2>&1
}

# Ensure Docker image exists
ensure_docker_image() {
    if ! docker image inspect "$DOCKER_IMAGE" &>/dev/null 2>&1; then
        echo "üì¶ Building linters Docker image (first time only)..."
        docker build -f "$REPO_ROOT/Dockerfile.linters" -t "$DOCKER_IMAGE" "$REPO_ROOT" >/dev/null 2>&1
    fi
}

# Run command in Docker or locally
run_linter() {
    local cmd=$1
    shift

    if has_docker; then
        ensure_docker_image
        docker run --rm -v "$REPO_ROOT:/workspace:ro" -w /workspace "$DOCKER_IMAGE" "$cmd" "$@" 2>&1
    else
        if command -v "$cmd" &>/dev/null; then
            "$cmd" "$@" 2>&1
        else
            echo "‚ö†Ô∏è  $cmd not available (install locally or use Docker)"
            return 1
        fi
    fi
}

echo "üîç Running pre-commit checks..."

# Check for merge conflict markers
if git diff --cached --check; then
    echo "‚úÖ No merge conflict markers found"
else
    echo "‚ùå Merge conflict markers detected"
    exit 1
fi

# Check for large files (>1MB)
large_files=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -c%s "{}") -gt 1048576 ]; then echo "{}"; fi' | head -5)
if [ -n "$large_files" ]; then
    echo "‚ö†Ô∏è  Large files detected (>1MB):"
    echo "$large_files"
    echo "Consider using Git LFS for large files"
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for secrets/sensitive data
echo "üîê Checking for secrets..."

# Check for sensitive filenames
sensitive_files=$(git diff --cached --name-only | grep -iE '\.(env|pem|key|cert|crt|p12|pfx|asc|gpg)$|id_rsa|id_dsa|id_ecdsa|credentials|secret|password|apikey' || true)
if [ -n "$sensitive_files" ]; then
    echo "‚ùå Sensitive files detected:"
    echo "$sensitive_files"
    echo "These file types should not be committed. Add them to .gitignore"
    exit 1
fi

# Enhanced secret patterns
declare -a secret_patterns=(
    # Generic secrets
    "password\s*[:=]\s*['\"][^'\"]{6,}['\"]"
    "secret\s*[:=]\s*['\"][^'\"]{8,}['\"]"
    "api[_-]?key\s*[:=]\s*['\"][^'\"]{8,}['\"]"
    "token\s*[:=]\s*['\"][^'\"]{8,}['\"]"
    "private[_-]?key\s*[:=]"

    # AWS
    "AKIA[0-9A-Z]{16}"                          # AWS Access Key ID
    "aws[_-]?secret[_-]?access[_-]?key"

    # GitHub
    "gh[pousr]_[0-9a-zA-Z]{36}"                 # GitHub token
    "github[_-]?token"

    # Stripe
    "sk_live_[0-9a-zA-Z]{24}"
    "rk_live_[0-9a-zA-Z]{24}"

    # Google/GCP
    "AIza[0-9A-Za-z\\-_]{35}"                   # Google API Key

    # Slack
    "xox[baprs]-[0-9a-zA-Z-]+"                  # Slack token

    # Private keys
    "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----"
)

# Check each pattern
for pattern in "${secret_patterns[@]}"; do
    if git diff --cached | grep -iE "$pattern" >/dev/null 2>&1; then
        echo "‚ùå Potential secret detected matching pattern: $pattern"
        echo "Matched content:"
        git diff --cached | grep -iE "$pattern" | head -3
        echo ""
        echo "Please remove sensitive data before committing"
        echo "Use environment variables or secret management tools instead"
        exit 1
    fi
done

# Check for high-entropy strings (possible secrets)
# This catches base64-encoded secrets and random strings
# Exclude:
#   - lazy-lock.json (contains git commit SHAs)
#   - Lines containing file paths (/sys/, /proc/, /dev/, /etc/, /usr/, /var/, /home/, /tmp/)
#   - Lines containing URLs (http://, https://)
suspicious_strings=$(git diff --cached -- . ':!*lazy-lock.json' | grep '^+' | grep -vE '/(sys|proc|dev|etc|usr|var|home|tmp)/' | grep -vE 'https?://' | grep -oE '[A-Za-z0-9+/]{40,}={0,2}' || true)
if [ -n "$suspicious_strings" ]; then
    echo "‚ö†Ô∏è  High-entropy strings detected (possible secrets):"
    echo "$suspicious_strings" | head -3
    echo ""
    read -p "These look like possible secrets. Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "‚úÖ No secrets detected"

# Validate shell scripts
shell_files=$(git diff --cached --name-only | grep -E '\.(sh|bash)$|^bin/' || true)
if [ -n "$shell_files" ]; then
    echo "üìù Checking shell script syntax..."
    for file in $shell_files; do
        if [ -f "$file" ]; then
            # Skip if not a shell script
            if ! head -1 "$file" | grep -q '^#!.*sh'; then
                continue
            fi

            if ! bash -n "$file" 2>/dev/null; then
                echo "‚ùå Shell script syntax error in $file"
                exit 1
            fi
        fi
    done
    echo "‚úÖ Shell script syntax valid"

    # Run shellcheck (Docker or local)
    echo "üîç Running shellcheck..."
    for file in $shell_files; do
        if [ -f "$file" ]; then
            # Skip if not a shell script or is a zsh script
            first_line=$(head -1 "$file")
            if ! echo "$first_line" | grep -q '^#!.*sh'; then
                continue
            fi
            if echo "$first_line" | grep -q 'zsh'; then
                continue
            fi

            if ! run_linter shellcheck -x "$file"; then
                echo "‚ùå ShellCheck failed for $file"
                echo "Fix the issues or use # shellcheck disable=SCXXXX to suppress specific warnings"
                exit 1
            fi
        fi
    done
    echo "‚úÖ ShellCheck passed"
fi

# Check Lua files (for Neovim config)
lua_files=$(git diff --cached --name-only | grep '\.lua$' || true)
if [ -n "$lua_files" ]; then
    echo "üìù Checking Lua files..."
    for file in $lua_files; do
        if [ -f "$file" ]; then
            # Use luac -p for syntax check without execution
            # This avoids errors from undefined globals like 'vim' in Neovim configs
            if ! run_linter luac -p "$file" >/dev/null 2>&1; then
                echo "‚ùå Lua syntax error in $file"
                run_linter luac -p "$file"
                exit 1
            fi
        fi
    done
    echo "‚úÖ Lua files syntax valid"
fi

echo "‚úÖ Pre-commit checks passed"
exit 0