#!/bin/bash

# Development Environment Monitor & Performance Optimizer

set -e

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
info() { echo -e "${BLUE}[DEBUG]${NC} $1"; }
highlight() { echo -e "${PURPLE}[HIGHLIGHT]${NC} $1"; }

# Show help
show_help() {
    cat << EOF
üîß Development Environment Monitor

USAGE:
    dev-monitor <command> [options]

COMMANDS:
    status          Show system status overview
    performance     Analyze system performance
    processes       Monitor development processes
    ports           Show active ports and services
    disk            Disk usage analysis
    memory          Memory usage details
    network         Network monitoring
    services        Check development services
    optimize        Optimize system for development
    benchmark       Run development environment benchmarks
    health          Full system health check

OPTIONS:
    --watch         Continuous monitoring (where applicable)
    --json          JSON output format
    --export        Export results to file

EXAMPLES:
    dev-monitor status
    dev-monitor performance --watch
    dev-monitor ports
    dev-monitor optimize

EOF
}

# System status overview
show_status() {
    clear
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë                  üöÄ Development Environment Status           ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo
    
    # System info
    highlight "üìä System Information"
    echo "  üñ•Ô∏è  Hostname: $(hostname)"
    echo "  üêß OS: $(lsb_release -d 2>/dev/null | cut -f2- || uname -o)"
    echo "  üèóÔ∏è  Kernel: $(uname -r)"
    echo "  ‚è∞ Uptime: $(uptime -p 2>/dev/null || uptime | awk '{print $3,$4}')"
    echo "  üìÖ Date: $(date)"
    echo
    
    # CPU & Memory
    highlight "üî• Performance Metrics"
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    local memory_info=$(free -h | grep Mem)
    local memory_used=$(echo $memory_info | awk '{print $3}')
    local memory_total=$(echo $memory_info | awk '{print $2}')
    local memory_percent=$(echo $memory_info | awk '{printf "%.1f", ($3/$2)*100}')
    
    echo "  üß† CPU Usage: ${cpu_usage}%"
    echo "  üíæ Memory: $memory_used / $memory_total (${memory_percent}%)"
    
    # Disk usage
    local disk_usage=$(df -h / | tail -1 | awk '{print $5}' | cut -d'%' -f1)
    local disk_free=$(df -h / | tail -1 | awk '{print $4}')
    echo "  üíΩ Disk Usage: ${disk_usage}% (${disk_free} free)"
    echo
    
    # Development tools status
    highlight "üõ†Ô∏è  Development Tools"
    check_tool_status "Git" "git --version"
    check_tool_status "Node.js" "node --version"
    check_tool_status "Python" "python3 --version"
    check_tool_status "Docker" "docker --version"
    check_tool_status "Rust" "rustc --version"
    check_tool_status "Go" "go version"
    echo
    
    # Active development services
    highlight "üîß Development Services"
    check_service_port "PostgreSQL" 5432
    check_service_port "Redis" 6379
    check_service_port "MongoDB" 27017
    check_service_port "MySQL" 3306
    check_service_port "Docker API" 2375
    echo
    
    # Git repositories status
    highlight "üìÇ Project Status"
    show_git_status
}

# Check tool status
check_tool_status() {
    local name="$1"
    local command="$2"
    
    if eval "$command" &>/dev/null; then
        local version=$(eval "$command" 2>/dev/null | head -1)
        echo "  ‚úÖ $name: $version"
    else
        echo "  ‚ùå $name: Not installed"
    fi
}

# Check service port
check_service_port() {
    local name="$1"
    local port="$2"
    
    if ss -tuln | grep -q ":$port "; then
        echo "  ‚úÖ $name: Running on port $port"
    else
        echo "  ‚≠ï $name: Not running on port $port"
    fi
}

# Show git repositories status
show_git_status() {
    local projects_dir="$HOME/projects"
    local repos_dir="$HOME/repos"
    local changes=0
    local total=0
    
    for dir in "$projects_dir" "$repos_dir"; do
        if [[ -d "$dir" ]]; then
            find "$dir" -maxdepth 2 -name ".git" -type d | while read -r git_dir; do
                local repo_dir=$(dirname "$git_dir")
                local repo_name=$(basename "$repo_dir")
                cd "$repo_dir"
                
                if ! git diff --quiet || ! git diff --cached --quiet; then
                    echo "  üìù $repo_name: Has uncommitted changes"
                    ((changes++))
                fi
                ((total++))
            done 2>/dev/null
        fi
    done
    
    if [[ $total -eq 0 ]]; then
        echo "  üìÇ No Git repositories found"
    elif [[ $changes -eq 0 ]]; then
        echo "  ‚úÖ All repositories are clean"
    fi
}

# Performance analysis
analyze_performance() {
    highlight "üîç Performance Analysis"
    
    # CPU information
    echo "üìä CPU Information:"
    if [[ -f "/proc/cpuinfo" ]]; then
        local cpu_model=$(grep "model name" /proc/cpuinfo | head -1 | cut -d':' -f2 | xargs)
        local cpu_cores=$(nproc)
        echo "  üñ•Ô∏è  Model: $cpu_model"
        echo "  üî¢ Cores: $cpu_cores"
    fi
    
    # Load average
    local load_avg=$(uptime | awk -F'load average:' '{print $2}')
    echo "  üìà Load Average:$load_avg"
    echo
    
    # Memory analysis
    echo "üíæ Memory Analysis:"
    free -h
    echo
    
    # Top processes by CPU
    echo "üî• Top CPU Processes:"
    ps aux --sort=-%cpu | head -6 | awk 'NR==1 {print "  " $0} NR>1 {printf "  %-10s %5s %5s %s\n", $1, $3"%", $4"%", $11}'
    echo
    
    # Top processes by Memory
    echo "üß† Top Memory Processes:"
    ps aux --sort=-%mem | head -6 | awk 'NR==1 {print "  " $0} NR>1 {printf "  %-10s %5s %5s %s\n", $1, $3"%", $4"%", $11}'
    echo
    
    # Disk I/O (if iostat available)
    if command -v iostat &>/dev/null; then
        echo "üíΩ Disk I/O:"
        iostat -x 1 1 | tail -n +4
        echo
    fi
    
    # Network interfaces
    echo "üåê Network Interfaces:"
    ip -brief addr show | grep -E "(UP|DOWN)" | while read -r line; do
        echo "  $line"
    done
}

# Monitor development processes
monitor_processes() {
    highlight "üîç Development Processes"
    
    local dev_processes=("node" "python" "rust" "go" "docker" "code" "nvim" "tmux")
    
    for process in "${dev_processes[@]}"; do
        local pids=$(pgrep -f "$process" 2>/dev/null || true)
        if [[ -n "$pids" ]]; then
            echo "üì± $process processes:"
            echo "$pids" | while read -r pid; do
                if [[ -n "$pid" ]]; then
                    local info=$(ps -p "$pid" -o pid,ppid,%cpu,%mem,etime,cmd --no-headers 2>/dev/null || true)
                    if [[ -n "$info" ]]; then
                        echo "  $info"
                    fi
                fi
            done
            echo
        fi
    done
}

# Show active ports
show_ports() {
    highlight "üîå Active Ports & Services"
    
    echo "Listening ports:"
    ss -tuln | grep LISTEN | sort -n -k5 | while read -r line; do
        local port=$(echo "$line" | awk '{print $5}' | sed 's/.*://')
        local service=$(getent services "$port" 2>/dev/null | awk '{print $1}' || echo "unknown")
        echo "  Port $port ($service): $line"
    done
    
    echo
    echo "Common development ports:"
    local dev_ports=(3000 3001 8000 8080 8888 5000 5432 6379 27017 3306 1433 9000)
    for port in "${dev_ports[@]}"; do
        if ss -tuln | grep -q ":$port "; then
            local service=$(getent services "$port" 2>/dev/null | awk '{print $1}' || echo "unknown")
            echo "  ‚úÖ Port $port ($service): Active"
        else
            echo "  ‚≠ï Port $port: Available"
        fi
    done
}

# Disk usage analysis
analyze_disk() {
    highlight "üíΩ Disk Usage Analysis"
    
    echo "Overall disk usage:"
    df -h | grep -E "(Filesystem|/dev/)" | awk '{printf "  %-20s %8s %8s %8s %5s %s\n", $1, $2, $3, $4, $5, $6}'
    echo
    
    echo "Development directories:"
    local dev_dirs=("$HOME/projects" "$HOME/repos" "$HOME/.local" "$HOME/.cache" "$HOME/.npm" "$HOME/.cargo" "/var/lib/docker")
    
    for dir in "${dev_dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            local size=$(du -sh "$dir" 2>/dev/null | cut -f1)
            local name=$(basename "$dir")
            echo "  üìÅ $name: $size"
        fi
    done
    
    echo
    echo "Largest directories in home:"
    du -h "$HOME" 2>/dev/null | sort -hr | head -10 | while read -r size path; do
        echo "  $size $(basename "$path")"
    done
}

# Network monitoring
monitor_network() {
    highlight "üåê Network Monitoring"
    
    echo "Network interfaces:"
    ip -brief addr show
    echo
    
    echo "Routing table:"
    ip route show | head -5
    echo
    
    if command -v ss &>/dev/null; then
        echo "Active connections:"
        ss -tuln | head -10
        echo
        
        echo "External connections:"
        ss -tun | grep ESTAB | head -5
    fi
    
    # DNS resolution test
    echo "DNS test:"
    for host in "google.com" "github.com" "npmjs.org"; do
        if ping -c 1 -W 2 "$host" &>/dev/null; then
            echo "  ‚úÖ $host: Reachable"
        else
            echo "  ‚ùå $host: Unreachable"
        fi
    done
}

# System optimization recommendations
optimize_system() {
    highlight "‚ö° System Optimization Recommendations"
    
    # Check swap usage
    local swap_usage=$(free | grep Swap | awk '{if($2>0) print ($3/$2)*100; else print 0}')
    if (( $(echo "$swap_usage > 50" | bc -l) )); then
        warn "High swap usage detected (${swap_usage}%). Consider adding more RAM."
    fi
    
    # Check available disk space
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | cut -d'%' -f1)
    if [[ $disk_usage -gt 90 ]]; then
        error "Disk space critically low (${disk_usage}% used)"
        echo "  üí° Run: dev-monitor disk"
        echo "  üí° Clean: docker system prune -a"
        echo "  üí° Clean: npm cache clean --force"
    elif [[ $disk_usage -gt 80 ]]; then
        warn "Disk space getting low (${disk_usage}% used)"
    fi
    
    # Check for outdated packages
    echo "üì¶ Package Management:"
    if command -v pacman &>/dev/null; then
        local updates=$(pacman -Qu 2>/dev/null | wc -l)
        if [[ $updates -gt 0 ]]; then
            warn "$updates package updates available"
            echo "  üí° Run: sudo pacman -Syu"
        else
            log "System packages are up to date"
        fi
    fi
    
    # Development environment recommendations
    echo
    echo "üõ†Ô∏è  Development Optimizations:"
    
    # Node.js optimization
    if command -v node &>/dev/null; then
        echo "  üì± Node.js optimizations:"
        echo "    ‚Ä¢ Set NODE_ENV=production for production apps"
        echo "    ‚Ä¢ Use npm ci instead of npm install in CI"
        echo "    ‚Ä¢ Clean npm cache: npm cache clean --force"
        
        local npm_cache_size=$(du -sh ~/.npm 2>/dev/null | cut -f1 || echo "unknown")
        echo "    ‚Ä¢ NPM cache size: $npm_cache_size"
    fi
    
    # Docker optimization
    if command -v docker &>/dev/null; then
        local docker_size=$(docker system df 2>/dev/null | tail -n +2 | awk '{sum+=$3} END {print sum/1024/1024/1024 " GB"}' || echo "unknown")
        echo "  üê≥ Docker optimizations:"
        echo "    ‚Ä¢ Docker space usage: $docker_size"
        echo "    ‚Ä¢ Clean unused containers: docker container prune"
        echo "    ‚Ä¢ Clean unused images: docker image prune -a"
        echo "    ‚Ä¢ Clean everything: docker system prune -a"
    fi
    
    # Git optimization
    echo "  üìö Git optimizations:"
    echo "    ‚Ä¢ Run git gc in large repositories"
    echo "    ‚Ä¢ Set git config core.preloadindex true"
    echo "    ‚Ä¢ Set git config core.fscache true (Windows)"
}

# Run benchmarks
run_benchmarks() {
    highlight "üèÉ Development Environment Benchmarks"
    
    echo "Running benchmarks..."
    
    # CPU benchmark
    echo "üî• CPU Benchmark (calculating œÄ):"
    local cpu_start=$(date +%s.%N)
    echo "scale=2000; 4*a(1)" | bc -l >/dev/null
    local cpu_end=$(date +%s.%N)
    local cpu_time=$(echo "$cpu_end - $cpu_start" | bc)
    echo "  Time: ${cpu_time}s"
    
    # Disk I/O benchmark
    echo "üíΩ Disk I/O Benchmark:"
    local disk_start=$(date +%s.%N)
    dd if=/dev/zero of=/tmp/benchmark_test bs=1M count=100 2>/dev/null
    sync
    local disk_end=$(date +%s.%N)
    rm -f /tmp/benchmark_test
    local disk_time=$(echo "$disk_end - $disk_start" | bc)
    echo "  Write 100MB: ${disk_time}s"
    
    # Network benchmark (if curl available)
    if command -v curl &>/dev/null; then
        echo "üåê Network Benchmark:"
        local net_start=$(date +%s.%N)
        curl -s -o /dev/null https://httpbin.org/bytes/1024 || true
        local net_end=$(date +%s.%N)
        local net_time=$(echo "$net_end - $net_start" | bc)
        echo "  Download 1KB: ${net_time}s"
    fi
    
    # Development tool benchmarks
    if command -v node &>/dev/null; then
        echo "üì± Node.js Benchmark:"
        local node_start=$(date +%s.%N)
        node -e "console.log('Node.js is ready')" >/dev/null
        local node_end=$(date +%s.%N)
        local node_time=$(echo "$node_end - $node_start" | bc)
        echo "  Node.js startup: ${node_time}s"
    fi
    
    if command -v python3 &>/dev/null; then
        echo "üêç Python Benchmark:"
        local python_start=$(date +%s.%N)
        python3 -c "print('Python is ready')" >/dev/null
        local python_end=$(date +%s.%N)
        local python_time=$(echo "$python_end - $python_start" | bc)
        echo "  Python startup: ${python_time}s"
    fi
}

# Health check
health_check() {
    highlight "üè• System Health Check"
    
    local issues=0
    
    # Critical system checks
    echo "üîç Critical System Checks:"
    
    # Disk space
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | cut -d'%' -f1)
    if [[ $disk_usage -gt 95 ]]; then
        error "Critical: Disk space extremely low (${disk_usage}%)"
        ((issues++))
    elif [[ $disk_usage -gt 85 ]]; then
        warn "Warning: Disk space low (${disk_usage}%)"
    else
        log "Disk space OK (${disk_usage}%)"
    fi
    
    # Memory usage
    local memory_percent=$(free | grep Mem | awk '{printf "%.0f", ($3/$2)*100}')
    if [[ $memory_percent -gt 90 ]]; then
        error "Critical: Memory usage very high (${memory_percent}%)"
        ((issues++))
    elif [[ $memory_percent -gt 80 ]]; then
        warn "Warning: Memory usage high (${memory_percent}%)"
    else
        log "Memory usage OK (${memory_percent}%)"
    fi
    
    # CPU load
    local load_avg=$(uptime | awk '{print $(NF-2)}' | cut -d',' -f1)
    local cpu_cores=$(nproc)
    local load_per_core=$(echo "scale=2; $load_avg / $cpu_cores" | bc)
    if (( $(echo "$load_per_core > 2.0" | bc -l) )); then
        error "Critical: High CPU load ($load_avg on $cpu_cores cores)"
        ((issues++))
    elif (( $(echo "$load_per_core > 1.0" | bc -l) )); then
        warn "Warning: Elevated CPU load ($load_avg on $cpu_cores cores)"
    else
        log "CPU load OK ($load_avg on $cpu_cores cores)"
    fi
    
    echo
    echo "üõ†Ô∏è  Development Environment Checks:"
    
    # Essential tools
    local tools=("git" "nvim" "tmux" "docker")
    for tool in "${tools[@]}"; do
        if command -v "$tool" &>/dev/null; then
            log "$tool: Available"
        else
            warn "$tool: Not installed"
            ((issues++))
        fi
    done
    
    echo
    if [[ $issues -eq 0 ]]; then
        highlight "‚úÖ All health checks passed!"
    else
        error "‚ùå Found $issues issue(s) that need attention"
    fi
}

# Main function
main() {
    local watch_mode=false
    local json_output=false
    
    # Parse flags
    while [[ $# -gt 0 ]]; do
        case $1 in
            --watch)
                watch_mode=true
                shift
                ;;
            --json)
                json_output=true
                shift
                ;;
            --export)
                # TODO: Implement export functionality
                shift
                ;;
            *)
                break
                ;;
        esac
    done
    
    local command="${1:-status}"
    
    if [[ "$watch_mode" == true ]]; then
        while true; do
            case "$command" in
                "status") show_status ;;
                "performance") analyze_performance ;;
                "processes") monitor_processes ;;
                "network") monitor_network ;;
            esac
            sleep 2
        done
    else
        case "$command" in
            "status") show_status ;;
            "performance") analyze_performance ;;
            "processes") monitor_processes ;;
            "ports") show_ports ;;
            "disk") analyze_disk ;;
            "memory") free -h ;;
            "network") monitor_network ;;
            "optimize") optimize_system ;;
            "benchmark") run_benchmarks ;;
            "health") health_check ;;
            "help"|"--help"|"-h") show_help ;;
            *) 
                error "Unknown command: $command"
                show_help
                exit 1
                ;;
        esac
    fi
}

# Execute main function
main "$@"