#!/bin/bash

# Smart Project Manager for 10x Developers

set -e

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

PROJECTS_DIR="$HOME/projects"
REPOS_DIR="$HOME/repos"
TEMPLATES_DIR="$HOME/Documents/templates"

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
info() { echo -e "${BLUE}[DEBUG]${NC} $1"; }

# Show help
show_help() {
    cat << EOF
ðŸš€ Project Manager - 10x Developer Edition

USAGE:
    project-manager <command> [options]

COMMANDS:
    new <name> [type]        Create new project with template
    list                     List all projects
    open [name]              Open project (with fzf if no name)
    clone <url> [name]       Clone and setup repository
    clean                    Clean up old projects
    backup                   Backup important projects
    stats                    Show project statistics
    templates                List available templates
    workspace [name]         Setup development workspace

PROJECT TYPES:
    node, python, rust, go, react, vue, nextjs, express, flask, fastapi

EXAMPLES:
    project-manager new my-app react
    project-manager open
    project-manager clone https://github.com/user/repo
    project-manager workspace frontend

EOF
}

# Create new project from template
create_project() {
    local name="$1"
    local type="${2:-node}"
    
    if [[ -z "$name" ]]; then
        error "Project name is required"
        echo "Usage: project-manager new <name> [type]"
        return 1
    fi
    
    local project_path="$PROJECTS_DIR/$name"
    
    if [[ -d "$project_path" ]]; then
        error "Project '$name' already exists"
        return 1
    fi
    
    log "Creating project '$name' of type '$type'..."
    mkdir -p "$project_path"
    cd "$project_path"
    
    case "$type" in
        "node"|"nodejs")
            init_node_project "$name"
            ;;
        "react")
            init_react_project "$name"
            ;;
        "nextjs"|"next")
            init_nextjs_project "$name"
            ;;
        "express")
            init_express_project "$name"
            ;;
        "python")
            init_python_project "$name"
            ;;
        "flask")
            init_flask_project "$name"
            ;;
        "fastapi")
            init_fastapi_project "$name"
            ;;
        "rust")
            init_rust_project "$name"
            ;;
        "go")
            init_go_project "$name"
            ;;
        "vue")
            init_vue_project "$name"
            ;;
        *)
            warn "Unknown project type '$type', creating basic project"
            init_basic_project "$name"
            ;;
    esac
    
    # Initialize git repository
    git init
    create_gitignore "$type"
    create_readme "$name" "$type"
    
    git add .
    git commit -m "Initial commit: $name ($type project)"
    
    log "âœ… Project '$name' created successfully!"
    info "ðŸ“‚ Location: $project_path"
    info "ðŸš€ To get started: cd $project_path"
}

# Initialize different project types
init_node_project() {
    local name="$1"
    npm init -y
    sed -i "s/\"name\": \".*\"/\"name\": \"$name\"/" package.json
    
    # Add common dev dependencies
    npm install -D prettier eslint typescript @types/node tsx
    
    # Create basic structure
    mkdir -p src tests docs
    echo "console.log('Hello from $name!');" > src/index.ts
    
    # Add npm scripts
    npm pkg set scripts.dev="tsx watch src/index.ts"
    npm pkg set scripts.build="tsc"
    npm pkg set scripts.start="node dist/index.js"
    npm pkg set scripts.test="echo 'No tests yet'"
    npm pkg set scripts.lint="eslint src/**/*.ts"
    npm pkg set scripts.format="prettier --write src/**/*.ts"
}

init_react_project() {
    local name="$1"
    npx create-react-app . --template typescript
    npm install -D @types/react @types/react-dom
}

init_nextjs_project() {
    local name="$1"
    npx create-next-app . --typescript --tailwind --eslint --app
}

init_express_project() {
    local name="$1"
    npm init -y
    npm install express cors helmet morgan dotenv
    npm install -D @types/express @types/cors @types/morgan @types/node typescript tsx nodemon
    
    mkdir -p src/routes src/middleware src/controllers tests
    
    cat > src/index.ts << EOF
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import dotenv from 'dotenv';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(helmet());
app.use(cors());
app.use(morgan('combined'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Routes
app.get('/', (req, res) => {
  res.json({ message: 'Hello from $name!' });
});

app.listen(PORT, () => {
  console.log(\`Server running on port \${PORT}\`);
});
EOF
    
    npm pkg set scripts.dev="tsx watch src/index.ts"
    npm pkg set scripts.build="tsc"
    npm pkg set scripts.start="node dist/index.js"
}

init_python_project() {
    local name="$1"
    
    if command -v poetry &> /dev/null; then
        poetry init --name "$name" --no-interaction
        poetry add --group dev pytest black flake8 mypy
    else
        python3 -m venv venv
        echo "venv/" > .gitignore
        pip install pytest black flake8 mypy
    fi
    
    mkdir -p src tests docs
    touch src/__init__.py tests/__init__.py
    echo "print('Hello from $name!')" > src/main.py
    
    cat > pyproject.toml << EOF
[tool.black]
line-length = 88
target-version = ['py311']

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
EOF
}

init_flask_project() {
    local name="$1"
    init_python_project "$name"
    
    if command -v poetry &> /dev/null; then
        poetry add flask python-dotenv
        poetry add --group dev flask-testing
    else
        pip install flask python-dotenv flask-testing
    fi
    
    cat > src/app.py << EOF
from flask import Flask, jsonify
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)

@app.route('/')
def hello():
    return jsonify({'message': 'Hello from $name!'})

if __name__ == '__main__':
    app.run(debug=True, port=os.getenv('PORT', 5000))
EOF
}

init_fastapi_project() {
    local name="$1"
    init_python_project "$name"
    
    if command -v poetry &> /dev/null; then
        poetry add fastapi uvicorn python-dotenv
        poetry add --group dev httpx
    else
        pip install fastapi uvicorn python-dotenv httpx
    fi
    
    cat > src/main.py << EOF
from fastapi import FastAPI
from dotenv import load_dotenv
import os

load_dotenv()

app = FastAPI(title="$name")

@app.get("/")
async def root():
    return {"message": "Hello from $name!"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=int(os.getenv("PORT", 8000)))
EOF
}

init_rust_project() {
    local name="$1"
    cargo init . --name "$name"
}

init_go_project() {
    local name="$1"
    go mod init "$name"
    
    cat > main.go << EOF
package main

import "fmt"

func main() {
    fmt.Println("Hello from $name!")
}
EOF
}

init_vue_project() {
    local name="$1"
    npx create-vue . --typescript --router --pinia --eslint --prettier
}

init_basic_project() {
    local name="$1"
    mkdir -p src tests docs
    echo "# $name" > README.md
    echo "# Basic project structure created" > src/README.md
}

# Create appropriate .gitignore
create_gitignore() {
    local type="$1"
    
    cat > .gitignore << EOF
# Editor files
.vscode/
.idea/
*.swp
*.swo
*~

# OS files
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Environment files
.env
.env.local
.env.*.local

EOF
    
    case "$type" in
        "node"|"react"|"nextjs"|"express"|"vue")
            cat >> .gitignore << EOF
# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.npm
.yarn/

# Build outputs
dist/
build/
.next/
.nuxt/

# Coverage
coverage/
*.lcov
EOF
            ;;
        "python"|"flask"|"fastapi")
            cat >> .gitignore << EOF
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
env.bak/
venv.bak/

# Distribution / packaging
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Testing
.coverage
.pytest_cache/
htmlcov/
.tox/
EOF
            ;;
        "rust")
            cat >> .gitignore << EOF
# Rust
target/
Cargo.lock
**/*.rs.bk
EOF
            ;;
        "go")
            cat >> .gitignore << EOF
# Go
*.exe
*.exe~
*.dll
*.so
*.dylib
*.test
*.out
go.work
EOF
            ;;
    esac
}

# Create README.md
create_readme() {
    local name="$1"
    local type="$2"
    
    cat > README.md << EOF
# $name

A $type project created with project-manager.

## Getting Started

### Prerequisites

EOF
    
    case "$type" in
        "node"|"react"|"nextjs"|"express"|"vue")
            cat >> README.md << EOF
- Node.js (v18+)
- npm or yarn

### Installation

\`\`\`bash
npm install
\`\`\`

### Development

\`\`\`bash
npm run dev
\`\`\`

### Build

\`\`\`bash
npm run build
\`\`\`
EOF
            ;;
        "python"|"flask"|"fastapi")
            cat >> README.md << EOF
- Python 3.11+
- Poetry (recommended) or pip

### Installation

\`\`\`bash
# Using Poetry
poetry install

# Using pip
python -m venv venv
source venv/bin/activate  # On Windows: venv\\Scripts\\activate
pip install -r requirements.txt
\`\`\`

### Development

\`\`\`bash
# Using Poetry
poetry run python src/main.py

# Using pip
python src/main.py
\`\`\`
EOF
            ;;
        "rust")
            cat >> README.md << EOF
- Rust (latest stable)

### Build

\`\`\`bash
cargo build
\`\`\`

### Run

\`\`\`bash
cargo run
\`\`\`
EOF
            ;;
        "go")
            cat >> README.md << EOF
- Go 1.21+

### Build

\`\`\`bash
go build
\`\`\`

### Run

\`\`\`bash
go run main.go
\`\`\`
EOF
            ;;
    esac
    
    cat >> README.md << EOF

## Project Structure

\`\`\`
$name/
â”œâ”€â”€ src/          # Source code
â”œâ”€â”€ tests/        # Test files
â”œâ”€â”€ docs/         # Documentation
â””â”€â”€ README.md     # This file
\`\`\`

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## License

This project is licensed under the MIT License.
EOF
}

# List all projects
list_projects() {
    log "ðŸ“ Your Projects:"
    
    if [[ -d "$PROJECTS_DIR" ]]; then
        find "$PROJECTS_DIR" -maxdepth 1 -type d -not -path "$PROJECTS_DIR" | while read -r project; do
            local name=$(basename "$project")
            local git_status=""
            
            if [[ -d "$project/.git" ]]; then
                cd "$project"
                local branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")
                local changes=$(git status --porcelain | wc -l)
                git_status=" (git:$branch"
                [[ $changes -gt 0 ]] && git_status="$git_status, $changes changes"
                git_status="$git_status)"
            fi
            
            echo "  â€¢ $name$git_status"
        done
    else
        warn "Projects directory not found: $PROJECTS_DIR"
    fi
    
    log "ðŸ“¦ Your Repositories:"
    if [[ -d "$REPOS_DIR" ]]; then
        find "$REPOS_DIR" -maxdepth 1 -type d -not -path "$REPOS_DIR" | while read -r repo; do
            echo "  â€¢ $(basename "$repo")"
        done
    fi
}

# Open project with fzf
open_project() {
    local name="$1"
    
    if [[ -n "$name" ]]; then
        local project_path="$PROJECTS_DIR/$name"
        if [[ -d "$project_path" ]]; then
            cd "$project_path"
            log "ðŸ“‚ Opened project: $name"
            return 0
        else
            error "Project '$name' not found"
            return 1
        fi
    fi
    
    # Use fzf to select project
    local projects=()
    [[ -d "$PROJECTS_DIR" ]] && mapfile -t projects < <(find "$PROJECTS_DIR" -maxdepth 1 -type d -not -path "$PROJECTS_DIR" -exec basename {} \;)
    [[ -d "$REPOS_DIR" ]] && mapfile -t -O "${#projects[@]}" projects < <(find "$REPOS_DIR" -maxdepth 1 -type d -not -path "$REPOS_DIR" -exec basename {} \;)
    
    if [[ ${#projects[@]} -eq 0 ]]; then
        warn "No projects found"
        return 1
    fi
    
    local selected
    selected=$(printf '%s\n' "${projects[@]}" | fzf --prompt="Select project: " --preview="[[ -f {}/README.md ]] && cat {}/README.md || echo 'No README found'")
    
    if [[ -n "$selected" ]]; then
        local project_path
        [[ -d "$PROJECTS_DIR/$selected" ]] && project_path="$PROJECTS_DIR/$selected"
        [[ -d "$REPOS_DIR/$selected" ]] && project_path="$REPOS_DIR/$selected"
        
        if [[ -n "$project_path" ]]; then
            cd "$project_path"
            log "ðŸ“‚ Opened project: $selected"
        fi
    fi
}

# Clone and setup repository
clone_repo() {
    local url="$1"
    local name="$2"
    
    if [[ -z "$url" ]]; then
        error "Repository URL is required"
        return 1
    fi
    
    if [[ -z "$name" ]]; then
        name=$(basename "$url" .git)
    fi
    
    local repo_path="$REPOS_DIR/$name"
    
    if [[ -d "$repo_path" ]]; then
        error "Repository '$name' already exists"
        return 1
    fi
    
    log "ðŸ”„ Cloning repository..."
    git clone "$url" "$repo_path"
    cd "$repo_path"
    
    # Auto-setup based on project type
    if [[ -f "package.json" ]]; then
        log "ðŸ“¦ Installing Node.js dependencies..."
        npm install
    elif [[ -f "pyproject.toml" ]]; then
        if command -v poetry &> /dev/null; then
            log "ðŸ Installing Python dependencies with Poetry..."
            poetry install
        fi
    elif [[ -f "Cargo.toml" ]]; then
        log "ðŸ¦€ Building Rust project..."
        cargo build
    elif [[ -f "go.mod" ]]; then
        log "ðŸ¹ Installing Go dependencies..."
        go mod download
    fi
    
    log "âœ… Repository '$name' cloned and setup successfully!"
    info "ðŸ“‚ Location: $repo_path"
}

# Show project statistics
show_stats() {
    log "ðŸ“Š Project Statistics:"
    
    local project_count=0
    local repo_count=0
    local total_size=0
    
    if [[ -d "$PROJECTS_DIR" ]]; then
        project_count=$(find "$PROJECTS_DIR" -maxdepth 1 -type d -not -path "$PROJECTS_DIR" | wc -l)
        if command -v du &> /dev/null; then
            local projects_size=$(du -sh "$PROJECTS_DIR" 2>/dev/null | cut -f1)
            echo "  ðŸ“ Projects: $project_count ($projects_size)"
        else
            echo "  ðŸ“ Projects: $project_count"
        fi
    fi
    
    if [[ -d "$REPOS_DIR" ]]; then
        repo_count=$(find "$REPOS_DIR" -maxdepth 1 -type d -not -path "$REPOS_DIR" | wc -l)
        if command -v du &> /dev/null; then
            local repos_size=$(du -sh "$REPOS_DIR" 2>/dev/null | cut -f1)
            echo "  ðŸ“¦ Repositories: $repo_count ($repos_size)"
        else
            echo "  ðŸ“¦ Repositories: $repo_count"
        fi
    fi
    
    # Language statistics
    if command -v tokei &> /dev/null; then
        log "ðŸ“ˆ Code Statistics (top languages):"
        tokei "$PROJECTS_DIR" "$REPOS_DIR" 2>/dev/null | head -15 || echo "  No code statistics available"
    fi
}

# Main command dispatcher
main() {
    case "${1:-help}" in
        "new"|"create")
            create_project "$2" "$3"
            ;;
        "list"|"ls")
            list_projects
            ;;
        "open"|"cd")
            open_project "$2"
            ;;
        "clone")
            clone_repo "$2" "$3"
            ;;
        "stats"|"statistics")
            show_stats
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

# Execute main function
main "$@"