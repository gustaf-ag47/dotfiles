#!/bin/bash

# Configuration - set these in your environment or local config
# BORG_BACKUP_DRIVE: Mount point for backup drive (e.g., /run/media/$USER/DRIVE-UUID)
# BORG_BACKUP_DEVICE: Device to mount if not mounted (e.g., /dev/sda1)

SRC_DIR="$SYNC"
BACKUP_DRIVE="${BORG_BACKUP_DRIVE:-/run/media/$USER/backup-drive}"
REPO_DIR="${BACKUP_DRIVE}/borg-repo"
BACKUP_DEVICE="${BORG_BACKUP_DEVICE:-/dev/sda1}"
DATE=$(date +"%Y-%m-%d")

if ! mountpoint -q "$BACKUP_DRIVE"; then
	echo "External drive is not mounted. Mounting now..."
	if ! sudo mount "$BACKUP_DEVICE" /mnt/backup; then
		echo "Failed to mount the external drive. Exiting."
		exit 1
	fi
fi

if [ ! -d "$REPO_DIR" ]; then
	echo "Initializing Borg repository at $REPO_DIR..."
	borg init --encryption=repokey "$REPO_DIR"
fi

borg create --stats --progress "$REPO_DIR::backup-$DATE" "$SRC_DIR"

echo "Backup completed successfully to Borg repository."
