#!/bin/bash

# Dunst Notification Manager

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

show_help() {
    cat << EOF
üîî Dunst Notification Manager

USAGE:
    dunst-manager <command> [options]

COMMANDS:
    status          Show dunst status
    restart         Restart dunst service
    test            Send test notifications
    center          Set notifications to center-top
    top-right       Set notifications to top-right
    bottom-center   Set notifications to bottom-center
    
    position <origin> <x> <y>    Set custom position
    
EXAMPLES:
    dunst-manager status
    dunst-manager restart
    dunst-manager test
    dunst-manager center
    dunst-manager position top-left 30 50

EOF
}

get_dunst_status() {
    if pgrep dunst >/dev/null; then
        log "Dunst is running (PID: $(pgrep dunst))"
        
        # Check current config
        local config_file="$HOME/.config/dunst/dunstrc"
        if [[ -f "$config_file" ]]; then
            local origin=$(grep "origin =" "$config_file" | awk '{print $3}' | head -1)
            local offset=$(grep "offset =" "$config_file" | awk '{print $3}' | head -1)
            log "Current position: $origin at offset $offset"
        fi
    else
        error "Dunst is not running"
        return 1
    fi
}

restart_dunst() {
    log "Restarting dunst..."
    killall dunst 2>/dev/null || true
    sleep 1
    dunst &
    sleep 1
    
    if pgrep dunst >/dev/null; then
        log "‚úÖ Dunst restarted successfully"
    else
        error "‚ùå Failed to restart dunst"
        return 1
    fi
}

send_test_notifications() {
    log "Sending test notifications..."
    
    notify-send "üéØ Test Notification" "This is a normal test notification" --urgency=normal
    sleep 1
    notify-send "‚ö†Ô∏è Warning Test" "This is a warning notification" --urgency=low
    sleep 1
    notify-send "üö® Critical Test" "This is a critical notification" --urgency=critical
    sleep 1
    notify-send "üéµ Media Test" "Now playing: Test Song\nArtist: Test Artist" --icon=audio-headphones
    
    log "‚úÖ Test notifications sent"
}

set_position() {
    local origin="$1"
    local x_offset="${2:-0}"
    local y_offset="${3:-50}"
    local config_file="$HOME/.config/dunst/dunstrc"
    
    if [[ ! -f "$config_file" ]]; then
        error "Dunst config file not found: $config_file"
        return 1
    fi
    
    log "Setting position to: $origin ($x_offset, $y_offset)"
    
    # Backup current config
    cp "$config_file" "$config_file.bak"
    
    # Update origin
    sed -i "s/origin = .*/origin = $origin/" "$config_file"
    
    # Update offset
    sed -i "s/offset = .*/offset = ($x_offset, $y_offset)/" "$config_file"
    
    # Restart dunst
    restart_dunst
    
    # Send test notification
    notify-send "üìç Position Updated" "Notifications now appear at: $origin" --urgency=normal
    
    log "‚úÖ Position updated to $origin"
}

case "${1:-status}" in
    "status")
        get_dunst_status
        ;;
    "restart")
        restart_dunst
        ;;
    "test")
        send_test_notifications
        ;;
    "center")
        set_position "top-center" 0 50
        ;;
    "top-right")
        set_position "top-right" 30 50
        ;;
    "top-left")
        set_position "top-left" 30 50
        ;;
    "bottom-center")
        set_position "bottom-center" 0 -50
        ;;
    "bottom-right")
        set_position "bottom-right" 30 -50
        ;;
    "bottom-left")
        set_position "bottom-left" 30 -50
        ;;
    "screen-center")
        set_position "center" 0 0
        ;;
    "position")
        if [[ -n "$2" && -n "$3" && -n "$4" ]]; then
            set_position "$2" "$3" "$4"
        else
            error "Usage: dunst-manager position <origin> <x_offset> <y_offset>"
            exit 1
        fi
        ;;
    "help"|"--help"|"-h")
        show_help
        ;;
    *)
        error "Unknown command: $1"
        show_help
        exit 1
        ;;
esac