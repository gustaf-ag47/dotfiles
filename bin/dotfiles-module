#!/bin/bash

# Dotfiles Module Management System
# Manages installation, enabling, and configuration of dotfiles modules

set -euo pipefail

DOTFILES="${DOTFILES:-$HOME/sync/src/dotfiles}"
MODULES_DIR="$DOTFILES/modules"
ENABLED_MODULES_FILE="$DOTFILES/.enabled-modules"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Load detection functions
source "$DOTFILES/install/detect.sh"

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
info() { echo -e "${BLUE}[DEBUG]${NC} $1"; }

show_usage() {
    cat << EOF
üîß Dotfiles Module Management

USAGE:
    dotfiles-module <command> [options]

COMMANDS:
    list                List all available modules
    enabled             List enabled modules  
    available           List modules available for current system
    install <module>    Install a specific module
    enable <module>     Enable a module
    disable <module>    Disable a module
    status <module>     Show module status
    detect              Show system detection info
    init                Initialize module system
    update              Update all enabled modules

EXAMPLES:
    dotfiles-module list                    # List all modules
    dotfiles-module available               # Show available for your system
    dotfiles-module install bluetooth       # Install bluetooth module
    dotfiles-module enable power-management # Enable power management
    dotfiles-module status all              # Show status of all modules

EOF
}

list_all_modules() {
    echo -e "${WHITE}üì¶ All Available Modules:${NC}"
    echo ""
    
    # Core modules
    echo -e "${GREEN}Core Modules:${NC}"
    for module in shell editor git tmux; do
        if [ -d "$DOTFILES/core/$module" ]; then
            echo -e "  ‚úÖ $module"
        fi
    done
    
    echo ""
    echo -e "${GREEN}Feature Modules:${NC}"
    
    if [ -d "$MODULES_DIR" ]; then
        for module_dir in "$MODULES_DIR"/*; do
            if [ -d "$module_dir" ]; then
                module_name=$(basename "$module_dir")
                if [ -f "$module_dir/README.md" ]; then
                    description=$(head -n 3 "$module_dir/README.md" | tail -n 1 | sed 's/^[#* ]*//')
                    echo -e "  üìã ${CYAN}$module_name${NC} - $description"
                else
                    echo -e "  üìã ${CYAN}$module_name${NC}"
                fi
            fi
        done
    fi
    
    echo ""
    echo -e "${GREEN}Desktop Environments:${NC}"
    for desktop in wayland x11 terminal; do
        if [ -d "$DOTFILES/desktop/$desktop" ]; then
            echo -e "  üñ•Ô∏è  $desktop"
        fi
    done
    
    echo ""
    echo -e "${GREEN}Platforms:${NC}"
    for platform in arch ubuntu macos linux; do
        if [ -d "$DOTFILES/platforms/$platform" ]; then
            echo -e "  üêß $platform"
        fi
    done
}

list_enabled_modules() {
    echo -e "${WHITE}‚úÖ Enabled Modules:${NC}"
    echo ""
    
    if [ -f "$ENABLED_MODULES_FILE" ]; then
        while IFS= read -r module; do
            if [ -n "$module" ] && [[ ! "$module" =~ ^# ]]; then
                echo -e "  ‚úÖ ${GREEN}$module${NC}"
            fi
        done < "$ENABLED_MODULES_FILE"
    else
        echo -e "  ${YELLOW}No modules enabled yet${NC}"
        echo -e "  ${BLUE}Run 'dotfiles-module init' to initialize${NC}"
    fi
}

list_available_modules() {
    echo -e "${WHITE}üéØ Available for Your System:${NC}"
    echo ""
    
    platform=$(detect_platform)
    desktop=$(detect_desktop)
    available_modules=($(detect_available_modules))
    
    echo -e "${GREEN}System Info:${NC}"
    echo -e "  Platform: ${CYAN}$platform${NC}"
    echo -e "  Desktop: ${CYAN}$desktop${NC}"
    echo ""
    
    echo -e "${GREEN}Recommended Modules:${NC}"
    for module in "${available_modules[@]}"; do
        if [ -d "$MODULES_DIR/$module" ]; then
            echo -e "  üéØ ${GREEN}$module${NC}"
        fi
    done
    
    echo ""
    echo -e "${GREEN}Platform Specific:${NC}"
    if [ -d "$DOTFILES/platforms/$platform" ]; then
        echo -e "  üêß ${GREEN}$platform${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}Desktop Specific:${NC}"
    desktop_family=$(echo "$desktop" | cut -d'/' -f1)
    if [ -d "$DOTFILES/desktop/$desktop_family" ]; then
        echo -e "  üñ•Ô∏è  ${GREEN}$desktop${NC}"
    fi
}

install_module() {
    local module="$1"
    
    if [ -z "$module" ]; then
        error "Module name required"
        return 1
    fi
    
    log "Installing module: $module"
    
    # Check if module exists
    module_path=""
    if [ -d "$MODULES_DIR/$module" ]; then
        module_path="$MODULES_DIR/$module"
    elif [ -d "$DOTFILES/core/$module" ]; then
        module_path="$DOTFILES/core/$module"
    elif [ -d "$DOTFILES/desktop/$(detect_desktop | cut -d'/' -f1)/$module" ]; then
        module_path="$DOTFILES/desktop/$(detect_desktop | cut -d'/' -f1)/$module"
    elif [ -d "$DOTFILES/platforms/$(detect_platform)/$module" ]; then
        module_path="$DOTFILES/platforms/$(detect_platform)/$module"
    else
        error "Module '$module' not found"
        return 1
    fi
    
    # Check if module has detect script
    if [ -f "$module_path/detect.sh" ]; then
        info "Checking module requirements..."
        if ! bash "$module_path/detect.sh"; then
            warn "Module requirements not met, installing anyway..."
        fi
    fi
    
    # Run installation script if available
    if [ -f "$module_path/install.sh" ]; then
        log "Running installation script for $module"
        bash "$module_path/install.sh"
    else
        warn "No installation script found for $module"
    fi
    
    # Enable the module
    enable_module "$module"
    
    log "Module '$module' installed successfully"
}

enable_module() {
    local module="$1"
    
    if [ -z "$module" ]; then
        error "Module name required"
        return 1
    fi
    
    # Create enabled modules file if it doesn't exist
    touch "$ENABLED_MODULES_FILE"
    
    # Check if already enabled
    if grep -q "^$module$" "$ENABLED_MODULES_FILE" 2>/dev/null; then
        warn "Module '$module' is already enabled"
        return 0
    fi
    
    # Add to enabled modules
    echo "$module" >> "$ENABLED_MODULES_FILE"
    log "Module '$module' enabled"
}

disable_module() {
    local module="$1"
    
    if [ -z "$module" ]; then
        error "Module name required"
        return 1
    fi
    
    if [ ! -f "$ENABLED_MODULES_FILE" ]; then
        warn "No enabled modules file found"
        return 1
    fi
    
    # Remove from enabled modules
    if grep -q "^$module$" "$ENABLED_MODULES_FILE"; then
        grep -v "^$module$" "$ENABLED_MODULES_FILE" > "${ENABLED_MODULES_FILE}.tmp"
        mv "${ENABLED_MODULES_FILE}.tmp" "$ENABLED_MODULES_FILE"
        log "Module '$module' disabled"
    else
        warn "Module '$module' was not enabled"
    fi
}

show_module_status() {
    local module="$1"
    
    if [ "$module" = "all" ]; then
        echo -e "${WHITE}üìä Module Status Overview:${NC}"
        echo ""
        
        # Show enabled modules
        if [ -f "$ENABLED_MODULES_FILE" ]; then
            echo -e "${GREEN}Enabled Modules:${NC}"
            while IFS= read -r mod; do
                if [ -n "$mod" ] && [[ ! "$mod" =~ ^# ]]; then
                    echo -e "  ‚úÖ $mod"
                fi
            done < "$ENABLED_MODULES_FILE"
        fi
        
        echo ""
        echo -e "${YELLOW}System Detection:${NC}"
        "$DOTFILES/install/detect.sh" info
        
        return 0
    fi
    
    # Check specific module status
    echo -e "${WHITE}üìä Status for module: $module${NC}"
    echo ""
    
    # Check if enabled
    if [ -f "$ENABLED_MODULES_FILE" ] && grep -q "^$module$" "$ENABLED_MODULES_FILE"; then
        echo -e "Status: ${GREEN}‚úÖ Enabled${NC}"
    else
        echo -e "Status: ${RED}‚ùå Disabled${NC}"
    fi
    
    # Check if module exists
    if [ -d "$MODULES_DIR/$module" ] || [ -d "$DOTFILES/core/$module" ]; then
        echo -e "Available: ${GREEN}‚úÖ Yes${NC}"
    else
        echo -e "Available: ${RED}‚ùå No${NC}"
    fi
    
    # Check requirements if detect script exists
    module_path=""
    [ -d "$MODULES_DIR/$module" ] && module_path="$MODULES_DIR/$module"
    [ -d "$DOTFILES/core/$module" ] && module_path="$DOTFILES/core/$module"
    
    if [ -n "$module_path" ] && [ -f "$module_path/detect.sh" ]; then
        echo -n "Requirements: "
        if bash "$module_path/detect.sh" >/dev/null 2>&1; then
            echo -e "${GREEN}‚úÖ Met${NC}"
        else
            echo -e "${RED}‚ùå Not met${NC}"
        fi
    fi
}

init_module_system() {
    log "Initializing module system..."
    
    # Create enabled modules file
    touch "$ENABLED_MODULES_FILE"
    
    # Add header comment
    if [ ! -s "$ENABLED_MODULES_FILE" ]; then
        cat > "$ENABLED_MODULES_FILE" << EOF
# Enabled Dotfiles Modules
# This file tracks which modules are currently enabled
# Edit manually or use 'dotfiles-module enable/disable'

EOF
    fi
    
    # Auto-detect and enable core modules
    log "Auto-detecting core modules..."
    for core_module in shell editor git tmux; do
        if [ -d "$DOTFILES/core/$core_module" ]; then
            enable_module "$core_module"
        fi
    done
    
    # Auto-detect available feature modules
    log "Auto-detecting available feature modules..."
    available_modules=($(detect_available_modules))
    for module in "${available_modules[@]}"; do
        if [ -d "$MODULES_DIR/$module" ]; then
            log "Found module: $module (run 'dotfiles-module enable $module' to enable)"
        fi
    done
    
    log "Module system initialized"
    echo ""
    echo -e "${BLUE}üí° Next steps:${NC}"
    echo -e "  ‚Ä¢ Run '${YELLOW}dotfiles-module available${NC}' to see recommended modules"
    echo -e "  ‚Ä¢ Run '${YELLOW}dotfiles-module enable <module>${NC}' to enable modules"
    echo -e "  ‚Ä¢ Run '${YELLOW}dotfiles-module install <module>${NC}' to install and enable modules"
}

main() {
    case "${1:-help}" in
        "list")
            list_all_modules
            ;;
        "enabled")
            list_enabled_modules
            ;;
        "available")
            list_available_modules
            ;;
        "install")
            install_module "${2:-}"
            ;;
        "enable")
            enable_module "${2:-}"
            ;;
        "disable")
            disable_module "${2:-}"
            ;;
        "status")
            show_module_status "${2:-all}"
            ;;
        "detect")
            "$DOTFILES/install/detect.sh" info
            ;;
        "init")
            init_module_system
            ;;
        "update")
            warn "Update functionality not yet implemented"
            ;;
        "help"|*)
            show_usage
            ;;
    esac
}

main "$@"