#!/bin/bash
set -euo pipefail

# Bluetooth Power Optimization Script
# Applies all possible tweaks to maximize Bluetooth power delivery and stability
# Run with: sudo bluetooth-power-optimize

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== Bluetooth Power Optimization ===${NC}\n"

# Check if running as root
if [[ $EUID -ne 0 ]]; then
	echo -e "${RED}Error: This script must be run as root${NC}"
	echo "Usage: sudo bluetooth-power-optimize"
	exit 1
fi

# 1. Force USB power control to "on" for Bluetooth device
echo -e "${YELLOW}1. Optimizing USB Power Management${NC}"

found=0
for dev in /sys/bus/usb/devices/*/; do
	if [[ -f "$dev/idVendor" ]]; then
		vendor=$(cat "$dev/idVendor" 2>/dev/null || echo "")
		product=$(cat "$dev/idProduct" 2>/dev/null || echo "")

		# Intel AX211 Bluetooth
		if [[ "$vendor" == "8087" && "$product" == "0033" ]]; then
			current=$(cat "$dev/power/control" 2>/dev/null || echo "unknown")
			echo "on" > "$dev/power/control" 2>/dev/null || true
			new=$(cat "$dev/power/control" 2>/dev/null || echo "unknown")

			if [[ "$new" == "on" ]]; then
				echo -e "${GREEN}✓ Intel AX211 USB power: $current → on${NC}"
				found=1
			else
				echo -e "${RED}✗ Failed to set USB power control${NC}"
			fi
			break
		fi
	fi
done

if [[ $found -eq 0 ]]; then
	echo -e "${YELLOW}⚠ Intel AX211 not found via USB (may be internal CNVio)${NC}"
fi

# 2. Verify btusb module parameter
echo -e "\n${YELLOW}2. Checking Bluetooth Driver Settings${NC}"

autosuspend=$(cat /sys/module/btusb/parameters/enable_autosuspend 2>/dev/null || echo "unknown")
if [[ "$autosuspend" == "N" ]]; then
	echo -e "${GREEN}✓ btusb autosuspend: disabled${NC}"
else
	echo -e "${YELLOW}⚠ btusb autosuspend: $autosuspend (expected: N)${NC}"
	echo "  Fix: Add 'options btusb enable_autosuspend=n' to /etc/modprobe.d/bluetooth-optimize.conf"
fi

# 3. Check WiFi power saving
echo -e "\n${YELLOW}3. Checking WiFi Power Saving${NC}"

iwlwifi_power=$(cat /sys/module/iwlwifi/parameters/power_save 2>/dev/null || echo "N/A")
if [[ "$iwlwifi_power" == "N" ]]; then
	echo -e "${GREEN}✓ WiFi power save: disabled${NC}"
else
	echo -e "${YELLOW}⚠ WiFi power save: enabled${NC}"
	echo "  Disabling WiFi power save..."
	echo "N" > /sys/module/iwlwifi/parameters/power_save 2>/dev/null || \
		echo -e "${RED}  ✗ Failed (add 'options iwlwifi power_save=0' to modprobe.d)${NC}"
fi

# 4. Check PCIe ASPM (Active State Power Management)
echo -e "\n${YELLOW}4. Checking PCIe Power Management${NC}"

aspm_policy=$(cat /sys/module/pcie_aspm/parameters/policy 2>/dev/null || echo "unknown")
if [[ "$aspm_policy" == *"[performance]"* ]]; then
	echo -e "${GREEN}✓ PCIe ASPM: performance mode${NC}"
elif [[ "$aspm_policy" == *"[default]"* ]]; then
	echo -e "${YELLOW}⚠ PCIe ASPM: default mode (may limit power)${NC}"
	echo "  Switching to performance mode..."
	echo "performance" > /sys/module/pcie_aspm/parameters/policy 2>/dev/null && \
		echo -e "${GREEN}  ✓ Set to performance${NC}" || \
		echo -e "${RED}  ✗ Failed (add 'pcie_aspm=off' to kernel boot params)${NC}"
else
	echo -e "${YELLOW}⚠ PCIe ASPM: $aspm_policy${NC}"
fi

# 5. Disable CPU frequency scaling for Bluetooth USB
echo -e "\n${YELLOW}5. Checking CPU Governor${NC}"

governor=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo "unknown")
if [[ "$governor" == "performance" ]]; then
	echo -e "${GREEN}✓ CPU governor: performance${NC}"
else
	echo -e "${YELLOW}⚠ CPU governor: $governor${NC}"
	echo "  Recommendation: Set to 'performance' for best Bluetooth stability"
fi

# 6. Check for USB 3.0 interference
echo -e "\n${YELLOW}6. Checking USB 3.0 Interference${NC}"

usb3_count=$(lsusb -t 2>/dev/null | grep -c "5000M" || echo "0")
if [[ "$usb3_count" -gt 0 ]]; then
	echo -e "${YELLOW}⚠ $usb3_count USB 3.0 device(s) detected${NC}"
	echo "  USB 3.0 can interfere with 2.4 GHz Bluetooth"
	echo "  Use shielded cables or USB 2.0 ports when possible"
else
	echo -e "${GREEN}✓ No USB 3.0 interference detected${NC}"
fi

# 7. Summary and recommendations
echo -e "\n${BLUE}=== Summary ===${NC}\n"

echo -e "${GREEN}Applied optimizations:${NC}"
echo "  • USB power control forced to 'on'"
echo "  • PCIe ASPM set to performance (if successful)"
echo "  • Verified btusb autosuspend disabled"
echo ""
echo -e "${YELLOW}Recommended next steps:${NC}"
echo "  1. Reconnect Bluetooth device: bluetooth"
echo "  2. Test range: walk to living room"
echo "  3. Check signal: bluetooth-diagnostics"
echo "  4. For permanent PCIe fix, add to /etc/default/grub:"
echo "     GRUB_CMDLINE_LINUX=\"pcie_aspm=off\""
echo "     Then: sudo grub-mkconfig -o /boot/grub/grub.cfg"
echo ""
echo -e "${BLUE}Note: These optimizations improve power delivery${NC}"
echo -e "${BLUE}but cannot exceed Class 2 hardware limits (~10m)${NC}"

echo -e "\n${GREEN}✓ Optimization complete!${NC}\n"
