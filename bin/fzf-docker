#!/usr/bin/env bash

# Docker FZF Manager
# Interactive Docker management using fzf
# Add to your dotfiles and run with: docker-fzf or alias it to 'dz'

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check dependencies
command -v fzf >/dev/null 2>&1 || { echo "Error: fzf is not installed"; exit 1; }
command -v docker >/dev/null 2>&1 || { echo "Error: docker is not installed"; exit 1; }

# Main menu
show_menu() {
    echo "ğŸ³ Docker Manager"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cat <<EOF
ğŸ“¦ containers    - Manage containers
ğŸ–¼ï¸  images        - Manage images  
ğŸ’¾ volumes       - Manage volumes
ğŸŒ networks      - Manage networks
ğŸ—ï¸  builder       - Manage build cache
ğŸ“Š stats         - View system usage
ğŸ§¹ cleanup       - Cleanup operations
âŒ exit          - Exit
EOF
}

# Container operations
manage_containers() {
    local action
    action=$(echo -e "list\nstop\nstart\nrestart\nremove\nlogs\ninspect\nstats\nexec\nback" | \        fzf --prompt="Container action: " --height=40% --border --header="Select container action")
    
    case $action in
        list)
            docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
            read -r -p "Press enter to continue..."
            ;;
        stop)
            local container
            container=$(docker ps --format "{{.ID}} {{.Names}} {{.Status}}" | \                fzf --prompt="Stop container: " --preview="docker inspect {1}" --preview-window=right:60%)
            [ -n "$container" ] && docker stop "$(echo "$container" | awk '{print $1}')" && echo "âœ“ Stopped"
            ;;
        start)
            local container
            container=$(docker ps -a --filter "status=exited" --format "{{.ID}} {{.Names}}" | \                fzf --prompt="Start container: ")
            [ -n "$container" ] && docker start "$(echo "$container" | awk '{print $1}')" && echo "âœ“ Started"
            ;;
        restart)
            local container
            container=$(docker ps --format "{{.ID}} {{.Names}}" | \                fzf --prompt="Restart container: ")
            [ -n "$container" ] && docker restart "$(echo "$container" | awk '{print $1}')" && echo "âœ“ Restarted"
            ;;
        remove)
            local containers
            containers=$(docker ps -a --format "{{.ID}} {{.Names}} {{.Status}}" | \                fzf -m --prompt="Remove containers (tab to select multiple): " --header="TAB to select, ENTER to confirm")
            if [ -n "$containers" ]; then
                echo "$containers" | awk '{print $1}' | xargs docker rm -f
                echo "âœ“ Removed selected containers"
            fi
            ;;
        logs)
            local container
            container=$(docker ps -a --format "{{.ID}} {{.Names}}" | \                fzf --prompt="View logs: ")
            [ -n "$container" ] && docker logs -f "$(echo "$container" | awk '{print $1}')"
            ;;
        inspect)
            local container
            container=$(docker ps -a --format "{{.ID}} {{.Names}}" | \                fzf --prompt="Inspect container: ")
            [ -n "$container" ] && docker inspect "$(echo "$container" | awk '{print $1}')" | less
            ;;
        stats)
            docker stats --no-stream
            read -r -p "Press enter to continue..."
            ;;
        exec)
            local container
            container=$(docker ps --format "{{.ID}} {{.Names}}" | \                fzf --prompt="Exec into container: ")
            if [ -n "$container" ]; then
                local shell
                shell=$(echo -e "bash\nsh\nzsh" | fzf --prompt="Select shell: " --height=20%)
                [ -n "$shell" ] && docker exec -it "$(echo "$container" | awk '{print $1}')" "$shell"
            fi
            ;;
        back) return ;;
    esac
}

# Image operations
manage_images() {
    local action
    action=$(echo -e "list\nremove\npull\ntag\ninspect\nhistory\nback" | \        fzf --prompt="Image action: " --height=40% --border --header="Select image action")
    
    case $action in
        list)
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedSince}}"
            read -r -p "Press enter to continue..."
            ;;
        remove)
            local images
            images=$(docker images --format "{{.Repository}}:{{.Tag}} {{.ID}} {{.Size}}" | \                fzf -m --prompt="Remove images (tab to select multiple): " --header="TAB to select, ENTER to confirm")
            if [ -n "$images" ]; then
                echo "$images" | awk '{print $2}' | xargs docker rmi -f
                echo "âœ“ Removed selected images"
            fi
            ;;
        pull)
            read -r -p "Image name (e.g., nginx:latest): " image
            [ -n "$image" ] && docker pull "$image"
            ;;
        tag)
            local image
            image=$(docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | \                fzf --prompt="Tag image: ")
            if [ -n "$image" ]; then
                read -r -p "New tag: " newtag
                [ -n "$newtag" ] && docker tag "$(echo "$image" | awk '{print $2}')" "$newtag" && echo "âœ“ Tagged"
            fi
            ;;
        inspect)
            local image
            image=$(docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | \                fzf --prompt="Inspect image: ")
            [ -n "$image" ] && docker inspect "$(echo "$image" | awk '{print $2}')" | less
            ;;
        history)
            local image
            image=$(docker images --format "{{.Repository}}:{{.Tag}}" | \                fzf --prompt="Image history: ")
            [ -n "$image" ] && docker history "$image"
            read -r -p "Press enter to continue..."
            ;;
        back) return ;;
    esac
}

# Volume operations
manage_volumes() {
    local action
    action=$(echo -e "list\nremove\ninspect\ncreate\nback" | \        fzf --prompt="Volume action: " --height=40% --border --header="Select volume action")
    
    case $action in
        list)
            docker volume ls
            read -r -p "Press enter to continue..."
            ;;
        remove)
            local volumes
            volumes=$(docker volume ls --format "{{.Name}}" | \                fzf -m --prompt="Remove volumes (tab to select multiple): " --header="TAB to select, ENTER to confirm")
            if [ -n "$volumes" ]; then
                echo "$volumes" | xargs docker volume rm
                echo "âœ“ Removed selected volumes"
            fi
            ;;
        inspect)
            local volume
            volume=$(docker volume ls --format "{{.Name}}" | \                fzf --prompt="Inspect volume: ")
            [ -n "$volume" ] && docker volume inspect "$volume" | less
            ;;
        create)
            read -r -p "Volume name: " volname
            [ -n "$volname" ] && docker volume create "$volname" && echo "âœ“ Created volume: $volname"
            ;;
        back) return ;;
    esac
}

# Network operations
manage_networks() {
    local action
    action=$(echo -e "list\nremove\ninspect\ncreate\nback" | \        fzf --prompt="Network action: " --height=40% --border --header="Select network action")
    
    case $action in
        list)
            docker network ls
            read -r -p "Press enter to continue..."
            ;;
        remove)
            local networks
            networks=$(docker network ls --format "{{.ID}} {{.Name}}" | grep -v "bridge\|host\|none" | \                fzf -m --prompt="Remove networks (tab to select multiple): " --header="TAB to select, ENTER to confirm")
            if [ -n "$networks" ]; then
                echo "$networks" | awk '{print $1}' | xargs docker network rm
                echo "âœ“ Removed selected networks"
            fi
            ;;
        inspect)
            local network
            network=$(docker network ls --format "{{.Name}}" | \                fzf --prompt="Inspect network: ")
            [ -n "$network" ] && docker network inspect "$network" | less
            ;;
        create)
            read -r -p "Network name: " netname
            [ -n "$netname" ] && docker network create "$netname" && echo "âœ“ Created network: $netname"
            ;;
        back) return ;;
    esac
}

# Builder operations
manage_builder() {
    local action
    action=$(echo -e "list\nprune\nback" | \        fzf --prompt="Builder action: " --height=40% --border --header="Select builder action")
    
    case $action in
        list)
            docker builder du
            read -r -p "Press enter to continue..."
            ;;
        prune)
            echo -e "${YELLOW}This will remove all build cache${NC}"
            read -r -p "Continue? (y/N): " confirm
            if [[ $confirm == [yY] ]]; then
                docker builder prune -af
                echo "âœ“ Build cache cleared"
            fi
            ;;
        back) return ;;
    esac
}

# Stats and usage
show_stats() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}Docker System Usage${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    docker system df
    echo ""
    docker system df -v
    read -r -p "Press enter to continue..."
}

# Cleanup operations
cleanup_menu() {
    local action
    action=$(cat <<EOF | fzf --prompt="Cleanup action: " --height=50% --border --header="âš ï¸  Destructive operations"prune-containers    - Remove all stopped containers
prune-images        - Remove unused images
prune-volumes       - Remove unused volumes
prune-networks      - Remove unused networks
prune-all           - Prune everything (safe)
nuclear-stop-all    - Stop all containers
nuclear-remove-all  - Remove ALL containers (force)
nuclear-images      - Remove ALL images (force)
nuclear-volumes     - Remove ALL volumes (force)
nuclear-full        - ğŸ”¥ NUKE EVERYTHING ğŸ”¥
back                - Back to main menu
EOF
)

    case $action in
        prune-containers)
            docker container prune -f && echo "âœ“ Pruned stopped containers"
            ;;
        prune-images)
            docker image prune -af && echo "âœ“ Pruned unused images"
            ;;
        prune-volumes)
            docker volume prune -f && echo "âœ“ Pruned unused volumes"
            ;;
        prune-networks)
            docker network prune -f && echo "âœ“ Pruned unused networks"
            ;;
        prune-all)
            docker system prune -af --volumes && echo "âœ“ System pruned"
            ;;
        nuclear-stop-all)
            echo -e "${RED}Stopping ALL containers...${NC}"
            docker stop "$(docker ps -aq)" 2>/dev/null && echo "âœ“ All containers stopped" || echo "No containers running"
            ;;
        nuclear-remove-all)
            echo -e "${RED}âš ï¸  This will REMOVE ALL containers (including running ones)${NC}"
            read -r -p "Type 'yes' to confirm: " confirm
            if [[ $confirm == "yes" ]]; then
                docker rm -f "$(docker ps -aq)" 2>/dev/null && echo "âœ“ All containers removed" || echo "No containers to remove"
            fi
            ;;
        nuclear-images)
            echo -e "${RED}âš ï¸  This will REMOVE ALL images${NC}"
            read -r -p "Type 'yes' to confirm: " confirm
            if [[ $confirm == "yes" ]]; then
                docker rmi -f "$(docker images -q)" 2>/dev/null && echo "âœ“ All images removed" || echo "No images to remove"
            fi
            ;;
        nuclear-volumes)
            echo -e "${RED}âš ï¸  This will REMOVE ALL volumes (data loss!)${NC}"
            read -r -p "Type 'yes' to confirm: " confirm
            if [[ $confirm == "yes" ]]; then
                docker volume rm "$(docker volume ls -q)" 2>/dev/null && echo "âœ“ All volumes removed" || echo "No volumes to remove"
            fi
            ;;
        nuclear-full)
            echo -e "${RED}ğŸ”¥ğŸ”¥ğŸ”¥ NUCLEAR OPTION ğŸ”¥ğŸ”¥ğŸ”¥${NC}"
            echo -e "${RED}This will remove EVERYTHING:${NC}"
            echo "  - All containers (running and stopped)"
            echo "  - All images"
            echo "  - All volumes"
            echo "  - All networks"
            echo "  - All build cache"
            echo ""
            read -r -p "Type 'NUKE' to confirm: " confirm
            if [[ $confirm == "NUKE" ]]; then
                echo "Stopping containers..."
                docker stop "$(docker ps -aq)" 2>/dev/null || true
                echo "Removing containers..."
                docker rm "$(docker ps -aq)" 2>/dev/null || true
                echo "Removing images..."
                docker rmi -f "$(docker images -q)" 2>/dev/null || true
                echo "Removing volumes..."
                docker volume rm "$(docker volume ls -q)" 2>/dev/null || true
                echo "Removing networks..."
                docker network rm "$(docker network ls -q)" 2>/dev/null || true
                echo "Pruning builder cache..."
                docker builder prune -af 2>/dev/null || true
                echo "Final system prune..."
                docker system prune -af --volumes
                echo -e "${GREEN}âœ“ Everything nuked${NC}"
            else
                echo "Aborted"
            fi
            ;;
        back) return ;;
    esac
    
    [ "$action" != "back" ] && read -r -p "Press enter to continue..."
}

# Main loop
main() {
    while true; do
        clear
        show_menu
        
        choice=$(echo -e "containers\nimages\nvolumes\nnetworks\nbuilder\nstats\ncleanup\nexit" | \
            fzf --prompt="Select option: " --height=40% --border --header="ğŸ³ Docker Manager")
        
        case $choice in
            containers) manage_containers ;;
            images) manage_images ;;
            volumes) manage_volumes ;;
            networks) manage_networks ;;
            builder) manage_builder ;;
            stats) show_stats ;;
            cleanup) cleanup_menu ;;
            exit) echo "Bye! ğŸ‘‹"; exit 0 ;;
            *) exit 0 ;;
        esac
    done
}

# Run main
main
