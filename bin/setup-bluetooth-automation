#!/bin/bash

# Setup Bluetooth Automation Services

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

DOTFILES="$HOME/sync/src/dotfiles"
SYSTEMD_USER_DIR="$HOME/.config/systemd/user"

log "ðŸ”§ Setting up Bluetooth automation services..."

# Create systemd user directory
mkdir -p "$SYSTEMD_USER_DIR"

# Copy service files
log "ðŸ“‹ Installing systemd services..."

cp "$DOTFILES/config/systemd/user/bluetooth-auto-backup.service" "$SYSTEMD_USER_DIR/"
cp "$DOTFILES/config/systemd/user/bluetooth-auto-backup.timer" "$SYSTEMD_USER_DIR/"

# Reload systemd
log "ðŸ”„ Reloading systemd user services..."
systemctl --user daemon-reload

# Enable and start backup timer
log "â° Enabling daily backup timer..."
systemctl --user enable bluetooth-auto-backup.timer
systemctl --user start bluetooth-auto-backup.timer

# Create apartment entry detection script
log "ðŸ  Setting up location-based triggers..."

# Create a simple WiFi network monitor
cat > "$HOME/.local/bin/bluetooth-wifi-monitor" << 'EOF'
#!/bin/bash

# Simple WiFi network change monitor for Bluetooth automation

BLUETOOTH_MANAGER="$HOME/sync/src/dotfiles/bin/bluetooth-manager"
APARTMENT_TRIGGER="$HOME/sync/src/dotfiles/bin/apartment-trigger"
LOG_FILE="$HOME/.local/share/bluetooth-wifi-monitor.log"

log() {
    echo "$(date): $1" >> "$LOG_FILE"
}

PREVIOUS_NETWORK=""

while true; do
    CURRENT_NETWORK=$(iwgetid -r 2>/dev/null || echo "")
    
    if [[ "$CURRENT_NETWORK" != "$PREVIOUS_NETWORK" ]] && [[ -n "$CURRENT_NETWORK" ]]; then
        log "WiFi network changed to: $CURRENT_NETWORK"
        
        # Customize these network names for your setup
        case "$CURRENT_NETWORK" in
            "YourHomeWiFi"|"ApartmentWiFi"|"HomeNetwork")
                log "Home network detected - triggering apartment setup"
                "$APARTMENT_TRIGGER" &
                ;;
            "OfficeWiFi"|"WorkNetwork")
                log "Office network detected - triggering office setup"
                "$BLUETOOTH_MANAGER" office &
                ;;
            *)
                log "Unknown network - triggering auto-connect"
                "$BLUETOOTH_MANAGER" auto-connect &
                ;;
        esac
        
        PREVIOUS_NETWORK="$CURRENT_NETWORK"
    fi
    
    sleep 30
done
EOF

mkdir -p "$HOME/.local/bin"
chmod +x "$HOME/.local/bin/bluetooth-wifi-monitor"

# Create systemd service for WiFi monitoring
cat > "$SYSTEMD_USER_DIR/bluetooth-wifi-monitor.service" << EOF
[Unit]
Description=Bluetooth WiFi Network Monitor
After=network.target

[Service]
Type=simple
ExecStart=%h/.local/bin/bluetooth-wifi-monitor
Restart=always
RestartSec=10

[Install]
WantedBy=default.target
EOF

# Add manual trigger aliases to shell
log "ðŸ“ Adding convenience aliases..."

if ! grep -q "bluetooth-manager" "$HOME/.bashrc" 2>/dev/null; then
    cat >> "$HOME/.bashrc" << 'EOF'

# Bluetooth Manager Aliases
alias bt='bluetooth-manager'
alias bt-status='bluetooth-manager status'
alias bt-apartment='bluetooth-manager apartment'
alias bt-office='bluetooth-manager office'
alias bt-headphones='bluetooth-manager headphones'
alias bt-backup='bluetooth-manager backup'
EOF
fi

# Add to zshrc if it exists
if [[ -f "$HOME/.zshrc" ]]; then
    if ! grep -q "bluetooth-manager" "$HOME/.zshrc"; then
        cat >> "$HOME/.zshrc" << 'EOF'

# Bluetooth Manager Aliases
alias bt='bluetooth-manager'
alias bt-status='bluetooth-manager status'
alias bt-apartment='bluetooth-manager apartment'
alias bt-office='bluetooth-manager office'
alias bt-headphones='bluetooth-manager headphones'
alias bt-backup='bluetooth-manager backup'
EOF
    fi
fi

log "âœ… Bluetooth automation setup complete!"
echo
log "ðŸ“‹ Services installed:"
echo "  â€¢ bluetooth-auto-backup.timer - Daily automatic backups"
echo "  â€¢ bluetooth-wifi-monitor.service - Location-based automation"
echo
log "ðŸŽ¯ To enable WiFi-based automation:"
echo "  systemctl --user enable bluetooth-wifi-monitor.service"
echo "  systemctl --user start bluetooth-wifi-monitor.service"
echo
log "ðŸ“± Manual commands available:"
echo "  bt-apartment          # Connect apartment devices"
echo "  bt-office             # Connect office devices"  
echo "  bt-headphones         # Connect headphones"
echo "  bt-status             # Show status"
echo "  bt-backup             # Create backup"
echo
log "âš™ï¸  To customize WiFi network names:"
echo "  Edit: ~/.local/bin/bluetooth-wifi-monitor"
echo "  Add your actual WiFi network names"
echo
log "ðŸ” View logs:"
echo "  tail -f ~/.local/share/bluetooth-wifi-monitor.log"
echo "  tail -f ~/.local/share/apartment-trigger.log"